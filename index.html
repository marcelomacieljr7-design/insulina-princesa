<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>ğŸ‘‘ Insulina da Princesa ğŸŒˆ</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- PWA -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#ff69b4">

<style>
body {
  font-family: "Comic Sans MS", Arial, sans-serif;
  background: linear-gradient(135deg, #ffb6e6, #cce7ff, #fff1a8);
  margin: 0;
  padding: 15px;
}

.container {
  max-width: 420px;
  margin: auto;
  background: #fff;
  border-radius: 30px;
  padding: 20px;
  box-shadow: 0 8px 20px rgba(255,105,180,0.4);
  border: 4px solid #ff69b4;
  position: relative;
  overflow: hidden;
}

h1 {
  text-align: center;
  color: #ff1493;
  font-size: 26px;
}

.subtitle {
  text-align: center;
  font-size: 14px;
  color: #ff69b4;
  margin-bottom: 10px;
}

label {
  font-weight: bold;
  display: block;
  margin-top: 14px;
  color: #d63384;
}

input, select {
  width: 100%;
  padding: 12px;
  margin-top: 6px;
  border-radius: 18px;
  border: 2px solid #ffb6e6;
  font-size: 16px;
}

button {
  width: 100%;
  padding: 14px;
  border-radius: 25px;
  font-size: 17px;
  font-weight: bold;
  border: none;
  margin-top: 15px;
  cursor: pointer;
}

button.importar {
  background: linear-gradient(90deg, #ff69b4, #ffb6e6);
  color: #fff;
}

button.ver {
  background: linear-gradient(90deg, #87cefa, #cce7ff);
  color: #004c99;
}

button.calcular {
  background: linear-gradient(90deg, #ff1493, #ff69b4);
  color: #fff;
}

button.alimento {
  background: linear-gradient(90deg, #ffa07a, #ffdab9);
  color: #7a2d00;
}

.result {
  margin-top: 20px;
  padding: 18px;
  background: linear-gradient(135deg, #ffe4f2, #e6f4ff);
  border-radius: 25px;
  text-align: center;
  font-size: 20px;
  font-weight: bold;
  color: #c2185b;
}

.table-container {
  display: none;
  margin-top: 15px;
  font-size: 14px;
}

#cadastroAlimento {
  display: none;
  margin-top: 10px;
  padding: 12px;
  background: #fff5fb;
  border-radius: 20px;
}

/* âœ¨ EFEITO DE MAGIA âœ¨ */
.magic {
  position: absolute;
  font-size: 26px;
  animation: subir 1.5s ease-out forwards;
  pointer-events: none;
}

@keyframes subir {
  0% { opacity: 0; transform: translateY(20px) scale(0.5); }
  30% { opacity: 1; }
  100% { opacity: 0; transform: translateY(-120px) scale(1.5); }
}
</style>
</head>

<body>

<div class="container" id="container">
  <h1>ğŸ‘‘ Insulina da Princesa ğŸŒˆ</h1>
  <div class="subtitle">Cuidando com amor ğŸ’–</div>

  <button class="importar" onclick="importarPlanilha()">ğŸ”„ Atualizar Receita da Doutora</button>
  <button class="ver" onclick="mostrarTabela()">ğŸ“‹ Ver Receitinha</button>

  <label>ğŸ½ï¸ RefeiÃ§Ã£o</label>
  <select id="refeicao"></select>

  <label>ğŸ©¸ Glicemia</label>
  <input type="number" id="glicemia">

  <label>ğŸ Carboidratos comidos</label>
  <input type="number" id="carbo" value="0">

  <button class="alimento" onclick="toggleCadastro()">ğŸ“ Cadastrar alimento</button>

  <div id="cadastroAlimento">
    <input id="nomeAlimento" placeholder="Nome do alimento">
    <input id="unidadeAlimento" placeholder="Unidade (ex: colher)">
    <input id="carboAlimento" type="number" placeholder="Carbo por unidade (g)">
    <button class="alimento" onclick="salvarAlimento()">ğŸ’¾ Salvar alimento</button>

    <hr>

    <select id="listaAlimentos"></select>
    <input id="quantidadeAlimento" type="number" placeholder="Quantidade">
    <button class="alimento" onclick="usarAlimento()">â• Usar alimento</button>
  </div>

  <button class="calcular" onclick="calcular()">âœ¨ Calcular Magia âœ¨</button>

  <div class="result" id="resultado">
    ğŸ¦„ğŸŒˆ Pronta para a magia dos bichinhos encantados? ğŸ’–ğŸ°
  </div>

  <div class="table-container" id="tabela"></div>
</div>

<script>
const LINK_PLANILHA =
"https://docs.google.com/spreadsheets/d/e/2PACX-1vT9gdt_es77YBpU13wanXJom_PP0Y5GljpaMJ4eAcE8IudX-5bU7LZRynq84S3RGESdARd7bbl13oxS/pub?output=csv";

let dados = [];
let tabelaVisivel = false;

/* ===== EFEITO MÃGICO ===== */
function efeitoMagia() {
  const emojis = ["âœ¨","ğŸŒˆ","ğŸ¦„","ğŸ’–","â­","ğŸª„","ğŸ°"];
  const container = document.getElementById("container");

  for (let i = 0; i < 8; i++) {
    const span = document.createElement("span");
    span.className = "magic";
    span.innerText = emojis[Math.floor(Math.random() * emojis.length)];
    span.style.left = Math.random() * 80 + "%";
    span.style.bottom = "20px";
    container.appendChild(span);

    setTimeout(() => span.remove(), 1500);
  }
}

/* ===== ALIMENTOS ===== */
let alimentos = JSON.parse(localStorage.getItem("alimentos")) || [];

function toggleCadastro() {
  const div = document.getElementById("cadastroAlimento");
  div.style.display = div.style.display === "none" ? "block" : "none";
}

function salvarAlimento() {
  const nome = nomeAlimento.value;
  const unidade = unidadeAlimento.value;
  const carbo = Number(carboAlimento.value);

  if (!nome || !unidade || carbo <= 0) {
    alert("Preencha corretamente ğŸ’•");
    return;
  }

  alimentos.push({ nome, unidade, carbo });
  localStorage.setItem("alimentos", JSON.stringify(alimentos));

  nomeAlimento.value = "";
  unidadeAlimento.value = "";
  carboAlimento.value = "";

  atualizarListaAlimentos();
  alert("Alimento salvo ğŸŒˆ");
}

function atualizarListaAlimentos() {
  listaAlimentos.innerHTML = "";
  alimentos.forEach((a, i) => {
    const opt = document.createElement("option");
    opt.value = i;
    opt.text = `${a.nome} (${a.unidade})`;
    listaAlimentos.add(opt);
  });
}

function usarAlimento() {
  const idx = listaAlimentos.value;
  const qtd = Number(quantidadeAlimento.value);
  if (idx === "" || qtd <= 0) return;

  carbo.value = Number(carbo.value) + alimentos[idx].carbo * qtd;
  quantidadeAlimento.value = "";
}

/* ===== PLANILHA ===== */
async function importarPlanilha() {
  try {
    const res = await fetch(LINK_PLANILHA, { cache: "no-store" });
    const texto = await res.text();
    const linhas = texto.trim().split("\n");

    dados = linhas.slice(1).map(l => {
      const c = l.split(",");
      return { refeicao: c[0], cho: +c[2], meta: +c[3], fs: +c[4] };
    });

    localStorage.setItem("prescricao", JSON.stringify(dados));
    carregarRefeicoes();
    esconderTabela();
    alert("Receitinha atualizada ğŸ’–");
  } catch {
    carregarLocal();
  }
}

function carregarLocal() {
  const salvo = localStorage.getItem("prescricao");
  if (salvo) {
    dados = JSON.parse(salvo);
    carregarRefeicoes();
  }
}

function carregarRefeicoes() {
  refeicao.innerHTML = "";
  dados.forEach((d, i) => {
    const opt = document.createElement("option");
    opt.value = i;
    opt.text = d.refeicao;
    refeicao.add(opt);
  });
}

/* ===== CALCULAR ===== */
function calcular() {
  efeitoMagia();

  if (dados.length === 0) carregarLocal();
  if (dados.length === 0) return;

  const d = dados[refeicao.value];
  let dose = (glicemia.value - d.meta) / d.fs;

  if (carbo.value > 0) dose += (carbo.value / d.cho) * 0.5;

  dose = Math.floor(dose * 2) / 2;
  if (dose < 0) dose = 0;

  resultado.innerHTML = `ğŸ’‰ Dose mÃ¡gica:<br><b>${dose} unidades</b> âœ¨ğŸ¦„`;
}

/* ===== TABELA ===== */
function mostrarTabela() {
  if (dados.length === 0) carregarLocal();
  if (dados.length === 0) return;

  if (tabelaVisivel) {
    tabela.style.display = "none";
    tabelaVisivel = false;
    return;
  }

  let html = "<table><tr><th>ğŸ½ï¸</th><th>ğŸ¥–</th><th>ğŸ¯</th><th>ğŸ§®</th></tr>";
  dados.forEach(d => {
    html += `<tr><td>${d.refeicao}</td><td>${d.cho}</td><td>${d.meta}</td><td>${d.fs}</td></tr>`;
  });
  html += "</table>";

  tabela.innerHTML = html;
  tabela.style.display = "block";
  tabelaVisivel = true;
}

function esconderTabela() {
  tabela.style.display = "none";
  tabelaVisivel = false;
}

window.onload = () => {
  carregarLocal();
  atualizarListaAlimentos();
};

if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("service-worker.js");
}
</script>

</body>
</html>
