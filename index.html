<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>üëë Insulina da Princesa üåà</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- PWA -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#ff69b4">

<style>
body {
  font-family: "Comic Sans MS", Arial, sans-serif;
  background: linear-gradient(135deg, #ffb6e6, #cce7ff, #fff1a8);
  margin: 0;
  padding: 15px;
}

.container {
  max-width: 420px;
  margin: auto;
  background: #fff;
  border-radius: 30px;
  padding: 20px;
  box-shadow: 0 8px 20px rgba(255,105,180,0.4);
  border: 4px solid #ff69b4;
}

h1 {
  text-align: center;
  color: #ff1493;
  font-size: 26px;
}

.subtitle {
  text-align: center;
  font-size: 14px;
  color: #ff69b4;
  margin-bottom: 10px;
}

label {
  font-weight: bold;
  display: block;
  margin-top: 14px;
  color: #d63384;
}

input, select {
  width: 100%;
  padding: 12px;
  margin-top: 6px;
  border-radius: 18px;
  border: 2px solid #ffb6e6;
  font-size: 16px;
}

button {
  width: 100%;
  padding: 14px;
  border-radius: 25px;
  font-size: 17px;
  font-weight: bold;
  border: none;
  margin-top: 15px;
  cursor: pointer;
}

button.importar {
  background: linear-gradient(90deg, #ff69b4, #ffb6e6);
  color: #fff;
}

button.ver {
  background: linear-gradient(90deg, #87cefa, #cce7ff);
  color: #004c99;
}

button.calcular {
  background: linear-gradient(90deg, #ff1493, #ff69b4);
  color: #fff;
}

button.alimento {
  background: linear-gradient(90deg, #ffa07a, #ffdab9);
  color: #7a2d00;
}

.result {
  margin-top: 20px;
  padding: 18px;
  background: linear-gradient(135deg, #ffe4f2, #e6f4ff);
  border-radius: 25px;
  text-align: center;
  font-size: 20px;
  font-weight: bold;
  color: #c2185b;
}

.table-container {
  display: none;
  margin-top: 15px;
  font-size: 14px;
}

#cadastroAlimento {
  display: none;
  margin-top: 10px;
  padding: 12px;
  background: #fff5fb;
  border-radius: 20px;
}
</style>
</head>

<body>

<div class="container">
  <h1>üëë Insulina da Princesa üåà</h1>
  <div class="subtitle">Cuidando com amor üíñ</div>

  <button class="importar" onclick="importarPlanilha()">üîÑ Atualizar Receita da Doutora</button>
  <button class="ver" onclick="mostrarTabela()">üìã Ver Receitinha</button>

  <label>üçΩÔ∏è Refei√ß√£o</label>
  <select id="refeicao"></select>

  <label>ü©∏ Glicemia</label>
  <input type="number" id="glicemia">

  <label>üçé Carboidratos comidos</label>
  <input type="number" id="carbo" value="0">

  <!-- üçì ALIMENTOS -->
  <button class="alimento" onclick="toggleCadastro()">üçì Cadastrar alimento</button>

  <div id="cadastroAlimento">
    <input id="nomeAlimento" placeholder="Nome do alimento">
    <input id="unidadeAlimento" placeholder="Unidade (ex: colher)">
    <input id="carboAlimento" type="number" placeholder="Carbo por unidade (g)">
    <button class="alimento" onclick="salvarAlimento()">üíæ Salvar alimento</button>

    <hr>

    <select id="listaAlimentos"></select>
    <input id="quantidadeAlimento" type="number" placeholder="Quantidade">
    <button class="alimento" onclick="usarAlimento()">‚ûï Usar alimento</button>
  </div>

  <button class="calcular" onclick="calcular()">‚ú® Calcular Magia ‚ú®</button>

  <div class="result" id="resultado">Vamos calcular juntas üíï</div>

  <div class="table-container" id="tabela"></div>
</div>

<script>
/* LINK CSV DA PLANILHA */
const LINK_PLANILHA =
"https://docs.google.com/spreadsheets/d/e/2PACX-1vT9gdt_es77YBpU13wanXJom_PP0Y5GljpaMJ4eAcE8IudX-5bU7LZRynq84S3RGESdARd7bbl13oxS/pub?output=csv";

let dados = [];
let tabelaVisivel = false;

/* ===== ALIMENTOS ===== */
let alimentos = JSON.parse(localStorage.getItem("alimentos")) || [];

function toggleCadastro() {
  const div = document.getElementById("cadastroAlimento");
  div.style.display = div.style.display === "none" ? "block" : "none";
}

function salvarAlimento() {
  const nome = document.getElementById("nomeAlimento").value;
  const unidade = document.getElementById("unidadeAlimento").value;
  const carbo = Number(document.getElementById("carboAlimento").value);

  if (!nome || !unidade || carbo <= 0) {
    alert("Preencha corretamente üíï");
    return;
  }

  alimentos.push({ nome, unidade, carbo });
  localStorage.setItem("alimentos", JSON.stringify(alimentos));

  document.getElementById("nomeAlimento").value = "";
  document.getElementById("unidadeAlimento").value = "";
  document.getElementById("carboAlimento").value = "";

  atualizarListaAlimentos();
  alert("Alimento salvo üåà");
}

function atualizarListaAlimentos() {
  const select = document.getElementById("listaAlimentos");
  select.innerHTML = "";
  alimentos.forEach((a, i) => {
    const opt = document.createElement("option");
    opt.value = i;
    opt.text = `${a.nome} (${a.unidade})`;
    select.add(opt);
  });
}

function usarAlimento() {
  const idx = document.getElementById("listaAlimentos").value;
  const qtd = Number(document.getElementById("quantidadeAlimento").value);
  if (idx === "" || qtd <= 0) return;

  const total = alimentos[idx].carbo * qtd;
  const campoCarbo = document.getElementById("carbo");
  campoCarbo.value = Number(campoCarbo.value) + total;

  document.getElementById("quantidadeAlimento").value = "";
}

/* ===== PLANILHA ===== */
async function importarPlanilha() {
  try {
    const res = await fetch(LINK_PLANILHA, { cache: "no-store" });
    const texto = await res.text();
    const linhas = texto.trim().split("\n");

    dados = linhas.slice(1).map(l => {
      const c = l.split(",");
      return {
        refeicao: c[0],
        cho: parseFloat(c[2]),
        meta: parseFloat(c[3]),
        fs: parseFloat(c[4])
      };
    });

    localStorage.setItem("prescricao", JSON.stringify(dados));
    carregarRefeicoes();
    esconderTabela();

    alert("Receitinha atualizada com sucesso üíñ");
  } catch {
    alert("Sem internet üåßÔ∏è Usando a √∫ltima receitinha salva");
    carregarLocal();
  }
}

function carregarLocal() {
  const salvo = localStorage.getItem("prescricao");
  if (salvo) {
    dados = JSON.parse(salvo);
    carregarRefeicoes();
  }
}

function carregarRefeicoes() {
  const select = document.getElementById("refeicao");
  select.innerHTML = "";
  dados.forEach((d, i) => {
    const opt = document.createElement("option");
    opt.value = i;
    opt.text = d.refeicao;
    select.add(opt);
  });
}

/* ===== CALCULAR ===== */
function calcular() {
  if (dados.length === 0) carregarLocal();
  if (dados.length === 0) return;

  const idx = document.getElementById("refeicao").value;
  const glicemiaValor = Number(document.getElementById("glicemia").value);
  const carboValor = Number(document.getElementById("carbo").value);

  const d = dados[idx];
  let dose = (glicemiaValor - d.meta) / d.fs;

  if (carboValor > 0) {
    dose += (carboValor / d.cho) * 0.5;
  }

  dose = Math.floor(dose * 2) / 2;
  if (dose < 0) dose = 0;

  document.getElementById("resultado").innerHTML =
    `üíâ Dose m√°gica:<br><b>${dose} unidades</b> ‚ú®`;
}

/* ===== TABELA ===== */
function mostrarTabela() {
  if (dados.length === 0) carregarLocal();
  if (dados.length === 0) return;

  const div = document.getElementById("tabela");

  if (tabelaVisivel) {
    div.style.display = "none";
    tabelaVisivel = false;
    return;
  }

  let html = "<table><tr><th>üçΩÔ∏è Refei√ß√£o</th><th>ü•ñ CHO</th><th>üéØ Meta</th><th>üßÆ FS</th></tr>";
  dados.forEach(d => {
    html += `<tr><td>${d.refeicao}</td><td>${d.cho}</td><td>${d.meta}</td><td>${d.fs}</td></tr>`;
  });
  html += "</table>";

  div.innerHTML = html;
  div.style.display = "block";
  tabelaVisivel = true;
}

function esconderTabela() {
  document.getElementById("tabela").style.display = "none";
  tabelaVisivel = false;
}

/* ===== INIT ===== */
window.onload = () => {
  carregarLocal();
  atualizarListaAlimentos();
};

/* SERVICE WORKER */
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("service-worker.js");
}
</script>

</body>
</html>
